var com=com||{};com.yy=com.yy||{};com.yy.ent=com.yy.ent||{};com.yy.ent.AgenService=function(){this.index=0;this.priceList;this.editor;this.canForwarCase=true;this.toDelList=[];this.isUpdate=false};!function(b,a){b.prototype={init:function(){this.initServiceItem();var c=this;a("ul.nav li.canClick a").on("click",function(d){if(comStatus!=4&&a(d.target).attr("data-href").indexOf("company.action")!=-1){a.alert("发布后才能跳转我的首页！");return}if(!c.canForwarCase&&a(d.target).attr("data-href")!="/agency/admin/adminCompanyinfo.action"){a.alert("请先填写服务项目！");return}if(c.isUpdate){a.messagebox({title:"跳转确认",type:"ask",msg:"尚未保存修改，跳转其他页面将会丢失当前修改，是否继续跳转？",buttons:"",fn:function(e){if(e.index==0){location.href=a(d.target).attr("data-href")}}})}else{location.href=a(d.target).attr("data-href")}});a("input , textarea,select").live("change",{context:this},this.checkForUpdate);a("input[name='city']").live("focus",{context:this},this.checkForUpdate);this.initKindEditor()},initKindEditor:function(){var c=this;KindEditor.ready(function(d){var e=d.editor({allowFileManager:true,uploadJson:post_url+"admin/uploadServicePic.action"});c.editor=e})},checkForUpdate:function(c){c.data.context.isUpdate=true;a("input , textarea,select").die("change");a("input[name='city']").die("focus")},singleImgHandler:function(c){var d=this;var e=this.editor;var f=a("#serviceItemForm"+c);a(".photo-con",f).removeClass("warning");e.loadPlugin("image",function(){e.plugin.imageDialog({showRemote:false,clickFn:function(i,k,j,g,h,l){d.isUpdate=true;a("input:[name='picture']",f).val(i);e.hideDialog();a("img.targetUploadImg",f).attr("src",i).show();a("img.defaultUploadImg",f).hide()}})})},initServiceItem:function(){var c=this;a("#saveServiceItemNext").on("click",{context:this,obj:a("#saveServiceItemNext"),type:0},this.saveAndUpdateServiceItem);a("#saveServiceItemPre").on("click",{context:this,obj:a("#saveServiceItemPre"),type:1},this.saveAndUpdateServiceItem);a("#saveServiceItem").on("click",{context:this,obj:a("#saveServiceItem"),type:2},this.saveAndUpdateServiceItem);a("#appendServiceItem").on("click",{context:this},this.appendServiceItem);a.ajax({url:post_url+"admin/adminGetServiceItems.action",type:"GET",autoAlert:true,data:{},dataType:"json",success:function(d){if(d.result==0&&d.data){var f=d.data.serviceContentList;c.priceList=d.data.priceList;if(f.length==0){c.canForwarCase=false;var e={type:1};e.priceList=c.priceList[1];a(e.priceList).each(function(h,j){j.checked=true});f.push(e)}else{a(f).each(function(h,j){j.priceList=c.handlePirceRelateQua(d.data.priceList[j.type],d.data.contentQualityChoseList[j.service_id]);j.code=j.city;j.city=a.agencySelectFromCode(j.city,"city",",")})}var g=template("service_item_template",{list:f,index:0,cityList:$$selectServiceData});c.index=f.length-1;a("#serviceShowArea").html(g);a(f).each(function(j,k){var h=a("#serviceItemForm"+j);a("input[name='city']",h).agencySelect({maxLimit:5,initCodes:k.code,name:"service_city"});wordCount2(a("textarea[name='content']",h)[0],200,"recomWordNotice"+j)})}}})},saveAndUpdateServiceItem:function(i){var d=i.data.context;var h=i.data.obj;var g=i.data.type;var f={};f.handleError=function(j,k){if(j.attr("name")=="picture"){var e=j.closest("form");a(".photo-con",e).addClass("warning");a.alert(k)}else{j.addClass("warning");j.next("span.error").remove();if(k!=""&&typeof k!="undefined"){j.after('<span class="error">'+k+"</span>")}j.focus(function(){j.removeClass("warning");j.next("span.error").remove()})}};f.selfValitor=function(j,k){var e=false;var l=a("input[name='quality']",k);a(l).each(function(m,n){if(a(n).attr("checked")){e=true;return false}});if(!e){a.alert("请选服务价格！");a("#priceArea"+j).addClass("warning")}return e};var c=a.validateMultiForm("form",f);if(!c){return}if(g==2){a.messagebox({title:"保存发布确认",type:"ask",msg:"是否确定保存并正式发布信息？",buttons:"",fn:function(e){if(e.index==0){d.sendSaveRequest(h)}}})}else{d.sendSaveRequest(h)}return false},sendSaveRequest:function(g){var e=this;var c=a("form",a("#serviceShowArea"));var f=[];for(var d=0;d<c.length;d++){f.push(e.jsonArrayToJsonObject(a(c[d]).serializeArray()))}a(f).each(function(h,j){j.city=a.agencySelectFromName(j.city,"city",",")});a.ajax({url:post_url+"admin/adminSaveServiceItems.action",type:"post",data:{data:JSON.stringify(f),toDelList:JSON.stringify(e.toDelList)},dataType:"json",autoAlert:true,success:function(h){if(h.result==0){location.href=g.attr("data-href")}else{a.alert("保存失败！")}}})},appendServiceItem:function(j,f){var d=j.data.context;var h=[];var g={type:1};g.priceList=d.priceList[1];a(g.priceList).each(function(e,l){l.checked=true});h.push(g);var c;if(typeof f!="undefined"){c=f}else{c=++d.index}var k=template("service_item_template",{list:h,index:c,cityList:$$selectServiceData});a("#serviceShowArea").append(k);a("input[name='city']").agencySelect({maxLimit:5,initCodes:"",name:"service_city"})},delServiceItem:function(d){var c=a("#serviceItemForm"+d);var e=this;a.messagebox({title:"刪除确认",type:"ask",msg:"是否确认删除？",buttons:"",fn:function(g){if(g.index==0){c.remove();if(a("form").length==0){e.appendServiceItem({data:{context:e}},0)}var f=c.attr("data-service-id");if(f!=""){e.toDelList.push(f)}}}})},getServiceQulityByType:function(d,c){a.ajax({url:post_url+"admin/adminGetServiceQuality.action",type:"get",autoAlert:true,data:{type:d},dataType:"json",success:function(e){if(e.result==0&&e.data){var f="";a(e.data).each(function(g,h){f+=template("service_price_template",{item:h})});a("#priceArea"+c).html(f);a("input:[name='type']",a("#serviceItemForm"+c)).val(d)}}})},handlePirceRelateQua:function(g,d){var c=[];for(var e in g){var f={};this.putAll(f,g[e]);c.push(f)}a(c).each(function(h,j){for(var h=0;h<d.length;h++){if(j.quality==d[h].quality){j.checked=true;break}else{j.checked=false}}});return c},jsonArrayToJsonObject:function(f){var e={};if(f&&f.length&&f.length>0){for(var d=0;d<f.length;d++){if(typeof e[f[d].name]!="undefined"){if(e[f[d].name] instanceof Array){e[f[d].name].push(f[d].value)}else{var c=e[f[d].name];e[f[d].name]=[];e[f[d].name].push(c);e[f[d].name].push(f[d].value)}}else{e[f[d].name]=f[d].value}}}return e},putAll:function(e,d){for(var c in d){e[c]=d[c]}}}}(com.yy.ent.AgenService,jQuery);