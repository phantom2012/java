var com=com||{};com.yy=com.yy||{};com.yy.ent=com.yy.ent||{};com.yy.ent.AgenService=function(){this.index=0;this.pics=[];this.imgEditor;this.vedioEditor;this.toDelCaseList=[];this.isUpdate=false};!function(b,a){b.prototype={init:function(){if(a("#isFirstTime").val()==1){var d={data:{context:this}};this.appendCaseItem(d,0)}this.initClassicCase();var c=this;a("ul.nav li.canClick a").on("click",function(f){if(comStatus!=4&&a(f.target).attr("data-href").indexOf("company.action")!=-1){a.alert("发布后才能跳转我的首页！");return}if(c.isUpdate){a.messagebox({title:"跳转确认",type:"ask",msg:"尚未保存修改，跳转其他页面将会丢失当前修改，是否继续跳转？",buttons:"",fn:function(e){if(e.index==0){location.href=a(f.target).attr("data-href")}}})}else{location.href=a(f.target).attr("data-href")}});a("input , textarea").live("input",{context:this},this.checkForUpdate);a("input , textarea").live("change",{context:this},this.checkForUpdate);a("input[name='record_time']").live("focus",{context:this},this.checkForUpdate)},checkForUpdate:function(c){c.data.context.isUpdate=true;a("input , textarea").die("input").die("change");a("input[name='record_time']").die("focus")},initClassicCase:function(){a(this.pics).each(function(d,e){wordCount2(a("textarea:[name='content']",a("#caseItemForm"+d))[0],200,"recomWordNotice"+d)});a("#saveCaseItemNext").on("click",{context:this,obj:a("#saveCaseItemNext"),type:1},this.saveAndUpdateCaseItem);a("#saveCaseItemPre").on("click",{context:this,obj:a("#saveCaseItemPre"),type:0},this.saveAndUpdateCaseItem);a("#appendCaseItem").on("click",{context:this},this.appendCaseItem);var c=this;KindEditor.ready(function(e){var f=e.editor({allowFileManager:false,uploadJson:post_url+"admin/uploadCaseFile.action"});var d=e.editor({allowFileManager:false,uploadJson:post_url+"admin/uploadCaseVedio.action"});c.imgEditor=f;c.vedioEditor=d})},singleImgHandler:function(c){var e=this.imgEditor;var f=a("#caseItemForm"+c);var d=this;a("[name='J_selectVedio']",f).removeClass("warning");a("[name='J_selectImage']",f).removeClass("warning");a("[name='J_selectImages']",f).removeClass("warning");e.loadPlugin("image",function(){e.plugin.imageDialog({showRemote:false,clickFn:function(i,k,j,g,h,l){d.isUpdate=true;a("input:[name='head_pic_url']",f).val(i);a("input:[name='type']",f).val(0);e.hideDialog();a("div:[name='J_selectImage'] .alUploadImg",f).attr("src",i).show();a("div:[name='J_selectImage'] .upload-btn",f).hide()}})})},multiImgHandler:function(c){var e=this.imgEditor;var d=this;var f=a("#caseItemForm"+c);a("[name='J_selectVedio']",f).removeClass("warning");a("[name='J_selectImage']",f).removeClass("warning");a("[name='J_selectImages']",f).removeClass("warning");e.loadPlugin("multiimage",function(){var g=a("input:[name='case_id']",f).val();e.plugin.multiImageDialog({initImgUrls:d.pics[c],clickFn:function(h){d.isUpdate=true;var i=a("#albums");i.html("");e.hideDialog();if(h.length>0){a("input:[name='type']",f).val(1)}d.pics[c].length=0;a("input:[name='pic_urls']",f).remove();a(h).each(function(j,k){d.pics[c].push({url:k.url,id:k.id});f.append('<input type="hidden" name="pic_urls" value="'+k.url+'" />')});if(h.length>0&&a("input:[name='head_pic_url']",f).val()==""){a("input:[name='head_pic_url']",f).val(h[0].url);a("input:[name='picture_id']",f).val(h[0].id);a("div:[name='J_selectImages'] .alUploadImg",f).attr("src",h[0].url).show();a("div:[name='J_selectImages'] .upload-btn",f).hide()}if(h.length==0){a("input:[name='head_pic_url']",f).val("");a("input:[name='picture_id']",f).val("");a("div:[name='J_selectImages'] .alUploadImg",f).hide();a("div:[name='J_selectImages'] .upload-btn",f).show()}},removeFn:function(k,l){d.isUpdate=true;var j=(k==a("input:[name='head_pic_url']",f).val());var i=-1;var h=d.pics[c];if(h.length>0){d.removePic(h,k);if(j){if(h.length>0){i=h[0].id;a("input:[name='head_pic_url']",f).val(h[0].url);a("input:[name='picture_id']",f).val(h[0].id);a("div:[name='J_selectImages'] .alUploadImg",f).attr("src",h[0].url).show();a("div:[name='J_selectImages'] .upload-btn",f).hide()}else{a("input:[name='head_pic_url']",f).val("")}}}},imgClickFn:function(h,i){d.isUpdate=true;var j=a("div.ke-item:[data-id='"+i.id+"']");a(j.siblings()).each(function(k,l){a("div.ke-name",a(l)).text(a(l).attr("data-id"))});a("div.ke-name",j).text(i.id+"封面");a("input:[name='head_pic_url']",f).val(h);a("input:[name='picture_id']",f).val(i.id);a("div:[name='J_selectImages'] .alUploadImg",f).attr("src",h).show();a("div:[name='J_selectImages'] .upload-btn",f).hide()}})})},vedioHandler:function(d){var c=this.vedioEditor;var f=a("#caseItemForm"+d);var e=this;a("[name='J_selectVedio']",f).removeClass("warning");a("[name='J_selectImage']",f).removeClass("warning");a("[name='J_selectImages']",f).removeClass("warning");c.loadPlugin("image",function(){c.plugin.imageDialog({showRemote:false,clickFn:function(j,l,k,g,i,m){e.isUpdate=true;c.hideDialog();a("input:[name='vedio_url']",f).val(j);var h=a("input:[name='case_id']",f).val();a("input:[name='type']",f).val(0);a("div:[name='J_selectVedio'] .alUploadImg",f).attr("src","http://res.idol.yystatic.com/agency/images/agency/uploadVedioSuccess.jpg").show();a("div:[name='J_selectVedio'] .upload-btn",f).hide()}})})},handleErrorImg:function(d,f){var c=this.pics[d];var e=a("#caseItemForm"+d);if(c.length>0){a(f).attr("src",c[0].url);a("input:[name='picture_id']",e).val(c[0].id);a.ajax({url:post_url+"admin/adminChangeAlbumImg.action",type:"post",autoAlert:true,data:{case_id:a("input:[name='case_id']",e).val(),url:c[0].url,type:a("input:[name='type']",e).val(),picture_id:c[0].id},dataType:"json",success:function(g){}})}else{a("[name='J_selectImages'] .upload-btn",e).show();a("[name='J_selectImages'] .alUploadImg",e).hide()}},saveAndUpdateCaseItem:function(h){var d=h.data.context;var g=h.data.obj;var f={};f.handleError=function(e,i){e.addClass("warning");e.next("span.error").remove();if(i!=""&&typeof i!="undefined"){e.after('<span class="error">'+i+"</span>")}e.focus(function(){e.removeClass("warning");e.next("span.error").remove()})};f.selfValitor=function(j,l){var e=true;var k=a("input[name='type']",l).val();if(k=="0"){if(a("input[name='vedio_url']",l).val()==""){e=false;a("[name='J_selectVedio']",l).addClass("warning");a.alert("请上传视音频！")}else{if(a("input[name='head_pic_url']",l).val()==""){e=false;a("[name='J_selectImage']",l).addClass("warning");a.alert("请上传视音频封面图片！")}}}else{if(k=="1"){if(d.pics[j].length==0){e=false;a("[name='J_selectImages']",l).addClass("warning");a.alert("请上传图片！")}else{if(a("input[name='head_pic_url']",l).val()==""){e=false;a("[name='J_selectImages']",l).addClass("warning");a.alert("请设置图册封面图片！")}}}else{a("[name='J_selectVedio']",l).addClass("warning");a("[name='J_selectImage']",l).addClass("warning");a("[name='J_selectImages']",l).addClass("warning");a.alert("请上传视音频或者照片！");e=false}}return e};var c=a.validateMultiForm("form",f);if(!c){return}if(h.data.type==0){d.sendSaveRequest(h.data.type,g)}else{if(h.data.type==1){a.messagebox({title:"发布确认",type:"ask",msg:"是否确定正式发布信息？",buttons:"",fn:function(e){if(e.index==0){d.sendSaveRequest(h.data.type,g)}}})}}return false},sendSaveRequest:function(e,g){var c=a("form");var f=[];for(var d=0;d<c.length;d++){f.push(this.jsonArrayToJsonObject(a(c[d]).serializeArray()))}a.ajax({url:post_url+"admin/adminSaveCaseItems.action",type:"post",autoAlert:true,data:{data:JSON.stringify(f),type:e,toDelCaseList:JSON.stringify(this.toDelCaseList)},dataType:"json",success:function(h){if(h.result==0){location.href=g.attr("data-href")}else{if(e==1){a.alert("保存并发布失败！")}else{a.alert("保存失败！")}}}})},appendCaseItem:function(f,d){if(a("form").length==6){a.alert("最多能新增6项经典案例");return}var c=f.data.context;var d=c.pics.length;c.pics.push([]);var g=template("case_item_template",{i:d});a("div.case-item-list").append(g)},choseVeiodOrPicBnt:function(c,d,g){var f=a("#caseItemForm"+c);var e=a("input[name='type']",f);if(e.val()==""){if(d==0){a("div.upload-item-vedio",f).show();a("div.upload-item-img",f).hide()}else{a("div.upload-item-vedio",f).hide();a("div.upload-item-img",f).show()}a(g).addClass("active").siblings("a").removeClass("active")}},delCaseItem:function(d){var e=this;e.isUpdate=true;var c=a("#caseItemForm"+d);a.messagebox({title:"刪除确认",type:"ask",msg:"是否确认删除？",buttons:"",fn:function(h){if(h.index==0){c.remove();if(a("form").length==0){var g=template("case_item_template",{i:0});a("div.case-item-list").append(g);e.pics[d].length=0}var f=a("input[name='case_id']",c).val();if(f!=""){e.toDelCaseList.push(f)}}}})},handlePirceRelateQua:function(d,c){a(d).each(function(e,f){for(var e=0;e<c.length;e++){if(f.quality==c[e].quality){f.checked=true;break}else{f.checked=false}}})},jsonArrayToJsonObject:function(f){var e={};if(f&&f.length&&f.length>0){for(var d=0;d<f.length;d++){if(typeof e[f[d].name]!="undefined"){if(e[f[d].name] instanceof Array){e[f[d].name].push(f[d].value)}else{var c=e[f[d].name];e[f[d].name]=[];e[f[d].name].push(c);e[f[d].name].push(f[d].value)}}else{e[f[d].name]=f[d].value}}}return e},putAll:function(e,d){for(var c in d){e[c]=d[c]}},removePic:function(c,d){for(var e in c){if(c[e].url==d){c.remove(e)}}}}}(com.yy.ent.AgenService,jQuery);Array.prototype.remove=function(c,b){var a=this.slice((b||c)+1||this.length);this.length=c<0?this.length+c:c;return this.push.apply(this,a)};