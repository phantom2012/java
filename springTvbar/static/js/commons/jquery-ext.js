(function($){$.ajaxSetup({cache:false,traditional:true,contentType:"application/x-www-form-urlencoded; charset=UTF-8"});var ajax=$.ajax;var sendStateObj={};var errorHandler=function(s,xhr){var contentType=xhr.getResponseHeader("Content-Type");var data=xhr.responseText;try{data=eval("("+data+")")}catch(error){data={result:"400",msg:error}}var isHandler=false;if(s.exception){s.exception(data);isHandler=true}if(s.errorPage){window.location.href=s.errorPage;isHandler=true;return isHandler}if(s.autoAlert==true){s.alert(data);isHandler=true}return isHandler};var hasJsonException=function(xhr){return xhr.getResponseHeader("Json-Exception")=="jsExc"};$.ajax=function(s){if($.trim(s.type).toLowerCase()=="post"){var sendState=sendStateObj[s.url];if(!sendState){sendState={};sendStateObj[s.url]=sendState}if(sendState.isSending){return}sendState.isSending=true;s.sendState=sendState}var oldBeforeSend=s.beforeSend;s.beforeSend=function(xhr,s){if(s.showMask&&top.commonShowMask){top.commonShowMask()}var isSend=true;try{xhr.setRequestHeader("Request-Type","ajax")}catch(e){}if(oldBeforeSend){isSend=oldBeforeSend(xhr,s)}return isSend};var oldSuccess=s.success;s.success=function(data,status,xhr){if(hasJsonException(xhr)){errorHandler(s,xhr)}else{if(s.autoAlert==true&&s.dataType=="json"&&data&&data.result!=0&&data.msg){alert(data.msg);return}if(oldSuccess){oldSuccess(data,status,xhr)}}};var oldComplete=s.complete;s.complete=function(xhr,textStatus){if(s.sendState){s.sendState.isSending=false}if(oldComplete){oldComplete(xhr,textStatus)}};var oldError=s.error;s.error=function(xhr,textStatus,errorThrown){if(xhr.status>=500){if(s.errorPage){window.location.href=s.errorPage;return}if(hasJsonException(xhr)&&errorHandler(s,xhr)){return}}if(oldError){oldError(xhr,textStatus,errorThrown)}};s.alert=function(data){if(data.type=="ARGUMENT"){if($.messagebox){$.messagebox({type:"error",msg:"参数错误:"+data.msg})}else{alert("参数错误:"+data.msg)}}else{if(data.type=="NETWORK"){if($.messagebox){$.messagebox({type:"error",msg:"网络错误:"+data.msg})}else{alert("网络错误:"+data.msg)}}else{if(data.type=="BUSINESS"){if($.messagebox){$.messagebox({type:"error",msg:""+data.msg})}else{alert(""+data.msg)}}else{if(data.type=="NOLOGIN"){if($.messagebox){$.messagebox({type:"error",msg:""+data.msg,fn:function(){showLoginBox()}})}else{alert(""+data.msg)}}else{if($.messagebox){$.messagebox({type:"error",msg:"未知类型异常:"+data.msg})}else{alert("未知类型异常:"+data.msg)}}}}}};ajax(s)};var checkFn=function($this,options){var checks=$this.attr("check");var arr=checks.split(",");var msgs=$this.attr("msg").split(",");var validatorCache=$this.attr("validatorCache");var isCache=true;if(validatorCache==0){isCache=false}var validators=$this.data("validators");if(!isCache||!validators){var msg;validators=[];for(var i=0;i<arr.length;i++){var check=arr[i];if(!check){continue}var index=check.indexOf("(");var fun;if(index!=-1){fun=$.reg[check.substr(0,index)]}else{fun=$.reg[check]}if(!fun){msg="异常的检查器";fun=$.reg.__error__}else{var result;if(index!=-1){eval("fun=function(value){return $.reg."+check.substr(0,index)+"(value,"+check.substr(index+1)+"}")}msg=msgs[i]}validators.push([fun,msg])}if(isCache){$this.data("validators",validators)}}for(var i=0;i<validators.length;i++){var validator=validators[i];var result=validator[0]($this.val());if(!result){if(options.handleError){options.handleError($this,validator[1])}return false}}if(options.handleOk){options.handleOk($this)}return true};$.fn.extend({ajaxForm:function(formId,options){var settings={isBlurCheck:true};$.extend(settings,options);var $form=$("#"+formId);if(settings.isBlurCheck){$form.find("[check]").live("blur",function(){checkFn($(this),settings)})}$(this).each(function(index){$(this).click(function(){$.ajaxForm(formId,settings)})})}});$.extend({ajaxForm:function(formId,options){var $form=$("#"+formId);var settings={data:$form.serialize(),url:$form.attr("action"),type:$form.attr("method")||"POST",dataType:$form.attr("dataType")||"json",autoAlert:true,isSubmit:true,isDefaultCheck:true,isBlurCheck:true,validateFn:function(data){return true},handleError:function($this,msg){},handleOk:function($this){},handleOver:function(flag,settings){}};$.extend(settings,options);var v=settings.validateFn($form.serializeArray());if(!v){settings.handleOver(false,settings);return}var isOK=true;if(settings.isDefaultCheck){$form.find("[check]").each(function(){var $this=$(this);var r=checkFn($this,settings);if(!r){isOK=false}})}settings.handleOver(isOK,settings);if(isOK&&settings.isSubmit){$.ajax(settings)}},ajaxData:function(url,data,options){var settings={data:data,url:url,type:"POST",dataType:"json",autoAlert:true};$.extend(settings,options);$.ajax(settings)},reg:{__error__:function(v){return false},notBlank:function(v){return !/^\s*$/.test(v)},number:function(v){return/^\d+$/.test(v)},email:function(v){return/^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/.test(v)},chinese:function(v){return/^[\u2E80-\u9FFF]+$/.test(v)},maxLength:function(v,l){return $.chineseLength(v)<=l},minLength:function(v,l){return $.chineseLength(v)>=l}},alert:function(msg,type,options){if($.messagebox){var settings={type:type||"error",msg:msg};$.extend(settings,options);$.messagebox(settings)}else{alert(msg)}},englishLength:function(str){if(str==null){return 0}var v=str;if(typeof str!="string"){v=str+""}var length=v.length;var result=length;for(var i=0;i<length;i++){if((v.charCodeAt(i)&65280)!=0){result++}}return result},chineseLength:function(str){return($.englishLength(str)+1)>>1},validateMultiForm:function(element,option){var b=true;var forms=$(element);$(forms).each(function(i,$form){var checks=$($form).find("[check]");checks.each(function(){var $this=$(this);b=checkFn($this,option);if(!b){return false}});if(b&&typeof option.selfValitor!="undefined"){b=option.selfValitor(i,$($form))}if(!b){return false}});return b}})})(jQuery);