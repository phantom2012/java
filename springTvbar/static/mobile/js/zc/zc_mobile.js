var fansNum;var voteNum;var ticket;var fundNum;var hadVoteNum=0;var freeTicketNum=0;var projectId;var countDownInterval;var goal;var taskMap={};var status=-1;var round=1;var homeUrl="http://idol.yy.com/agency/";var ticketInterval;var anchorUid;$(document).ready(function(){projectId=$.url.param("projectId");$("div.vote-btn").unbind("click").bind("click",function(){checkTicketStatus(vote,true)});$("div.bottom-btns a:eq(1)").unbind("click").bind("click",function(){gotoPage(homeUrl+projectId);hiido_statPP(anchorUid,5,"mobile")});$("div.more").unbind("click").bind("click",function(){gotoPage(homeUrl+projectId);hiido_statPP(anchorUid,5,"mobile")});getAllTasks(projectId,$(".time span:eq(0)"));ticketInterval=setInterval(addZcTicketInterval,1000*60*5);checkTicketStatus(getFreeTicket,false);checkTicketStatus(setEnterClientTime,false)});function addZcTicketInterval(){checkTicketStatus(addTicket,false)}function refreshAct(json){var con=eval("("+json+")");if(json){fansNum=con.data.currentFansCnt||0;voteNum=con.data.currentVoteCnt||0;var tmpFreeTicketNum=con.data.freeTicketCnt;fundNum=con.data.fund||0;if(tmpFreeTicketNum||tmpFreeTicketNum==0){tmpFreeTicketNum=tmpFreeTicketNum||0;$("#freeTicketNum").text(tmpFreeTicketNum);freeTicketNum=parseInt(tmpFreeTicketNum)}round=computeRound(con.data.projectStatus);if(parseInt(fundNum)>10000000){$("#hasIncomeCount").text("超1千万")}else{$("#hasIncomeCount").text(fundNum)}if(round==1&&taskMap[1]!=null){$(".round").text("第1轮：录制新歌");$("#targetIncomeCount").text(taskMap[1].targetIncome);$("div.line-sub").css("width",getVoteRate(voteNum)+"%")}else{if(round==2&&taskMap[2]!=null){$(".round").text("第2轮：制作EP");$("#targetIncomeCount").text(taskMap[2].targetIncome);$("div.line-sub").css("width",getVoteRate(voteNum)+"%")}}if(status!=con.data.projectStatus){status=con.data.projectStatus;if(round==1||round==2){initCountDownTime(null,$("div.time span:eq(0)"))}}$("#curVoteNum").text(voteNum)}}function addTicket(a){$.ajax({url:"/agency/broadCastAddTicket.action",type:"post",data:{projectId:projectId,udbTicket:a},dataType:"json",success:function(b){freeTicketNum=parseInt(freeTicketNum)+1;$("#freeTicketNum").text(freeTicketNum)},exception:function(b){if(b.result==3005){clearInterval(ticketInterval);ticketInterval=0}}})}function resultToWeb(a){}function vote(a){freeTicketNum=parseInt($("#freeTicketNum").text());if(freeTicketNum<=0){return}$.ajax({url:"/agency/vote.action",type:"get",data:{projectId:projectId,udbTicket:a},dataType:"json",success:function(b){if(freeTicketNum>0){freeTicketNum=parseInt(freeTicketNum)-1;$(".vote-btn span").text(freeTicketNum)}},exception:function(b){alert(b.msg)}})}function getAllTasks(a,b){$.ajax({url:"/agency/getAllTasks.action",type:"get",data:{projectId:a},dataType:"json",success:function(f,d,g){status=f.data.status;anchorUid=f.data.anchorUid;round=computeRound(status);var e=f.data.taskList;$.each(e,function(h,j){var k=j.actId;taskMap[k]=j});if(round==1){$(".round").text("第1轮：录制新歌");$("#targetIncomeCount").text(taskMap[1].targetIncome);$("div.line-sub").css("width",getVoteRate(voteNum)+"%")}else{$(".round").text("第2轮：制作EP");$("#targetIncomeCount").text(taskMap[2].targetIncome);$("div.line-sub").css("width",getVoteRate(voteNum)+"%")}$("#curVoteNum").text(voteNum);if(round==1||round==2){var c=getServerNowDate(g.getResponseHeader("Date"));initCountDownTime(c,b)}},exception:function(c){alert(c.msg)}})}function getVoteRate(a){var b=taskMap[2].goal;var c=(a*100/b);if(c>100){c=100}return c}function getFreeTicket(a){$.ajax({url:"/agency/getFreeTicket.action",type:"get",data:{projectId:projectId,udbTicket:a},dataType:"json",success:function(c,b,d){status=c.data.status;freeTicketNum=parseInt(c.data.freeTicketNum);$("#freeTicketNum").text(freeTicketNum)},exception:function(b){alert(b.msg)}})}function computeRound(a){if(a==4){round=1}else{if(a==5){round=2}else{round=1}}return round}function getServerNowDate(c){var a=null;try{if(!c){a=new Date()}else{a=new Date(formatDate(c,"yyyy/MM/dd hh:mm:ss"))}}catch(b){if(a==null){a=new Date()}return a}return a}function getDownTimeEndDate(){var a=null;if(round==1||round==2){if(round==1){a=taskMap[1]}else{if(round==2){a=taskMap[2]}}}if(a!=null&&a!=""){if(a.endTime.length>2){return new Date(formatDate(a.endTime.substring(0,a.endTime.length-2),"yyyy/MM/dd hh:mm:ss"))}else{return null}}}function initCountDownTime(j,g){if(countDownInterval){clearInterval(countDownInterval);countDownInterval=null}if(!j){j=getServerNowDate(null)}var e=getDownTimeEndDate();if(e==null){return e}var f=e.getTime();if(f==null||f==""){return false}var i=j.getTime();var c=Math.ceil((f-i)/1000);if(c>6*24*3600){return false}if(c<0){c=0}var a=Math.floor(c/(60*60));var b=a*60*60;var d=Math.floor((c-b)/60);var h=c-b-d*60;showCountDownTime(a,d,h,g);var k={h:a,m:d,s:h};countDownInterval=setInterval(function(){countDownTime(k);showCountDownTime(k.h,k.m,k.s,g);if(k.h==0&&k.m==0&&k.s==0){clearInterval(countDownInterval);countDownInterval=null}},1000)}function showCountDownTime(a,d,c,b){if(a>23){b.text(Math.ceil(a/24)+"天")}else{b.text(a+":"+d+":"+c)}}function countDownTime(a){if(a.s==0&&(a.h>0||a.m>0)){a.s=59;if(a.m==0){a.m=59;a.h=a.h-1}else{a.m=a.m-1}}else{if(a.s>0){a.s=a.s-1}}}function setEnterClientTime(a){$.ajax({url:"/agency/setEnterClientTimeCache.action",type:"get",data:{projectId:projectId,udbTicket:a},dataType:"json",success:function(b){},exception:function(b){alert(b.msg)}})};